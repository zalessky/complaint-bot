#!/bin/bash
echo "🚀 Обновление до версии 0.8.1"
echo "====================================="
echo ""
echo "📋 Исправления:"
echo "  ✅ Возврат полей ФИО и телефон"
echo "  ✅ Исправлена дублировка геолокации"
echo "  ✅ Поддержка 0-3 фото (альбомы)"
echo "  ✅ Статусы с цветовыми эмодзи"
echo "  ✅ Inline кнопки для категорий"
echo "  ✅ Прогресс-бар (Шаг X из Y)"
echo "  ✅ Фото в админке и детальной карточке"
echo ""

# Остановим процессы
echo "🛑 Остановка процессов..."
tmux kill-session -t citybot 2>/dev/null
bash stop_app.sh 2>/dev/null
sleep 2

# Бэкап
echo "💾 Создание резервной копии..."
mkdir -p backups/v0.8.0_$(date +%Y%m%d_%H%M%S)
cp -r bot/handlers backups/v0.8.0_$(date +%Y%m%d_%H%M%S)/
cp -r backend/api backups/v0.8.0_$(date +%Y%m%d_%H%M%S)/
cp -r frontend backups/v0.8.0_$(date +%Y%m%d_%H%M%S)/

echo ""
echo "📝 Применение обновлений..."
echo ""

# ===========================================
# 1. Обновление config/categories.json - добавляем ФИО
# ===========================================
cat > config/categories.json << 'CATEOF'
{
  "categories": {
    "🚌 Транспорт и остановки": {
      "description": "Проблемы общественного транспорта и остановок",
      "fields": ["route_number", "vehicle_number", "description", "photos", "contact_name", "contact_phone"],
      "subcategories": [
        "😡 Поведение водителя (грубость, курение)",
        "🚦 Нарушение ПДД водителем",
        "🧹 Грязный салон",
        "🛠️ Неисправность транспортного средства",
        "⏰ Нарушение графика/игнорирование остановки",
        "🚫 Отказ в приеме карты/проездного/льготы",
        "♿ Трудности при посадке",
        "🏚️ Нет павильона",
        "🪣 Павильон грязный/сломанный",
        "🪧 Нет названия остановки",
        "🧭 Неверный маршрут/самовольный объезд",
        "🔍 Другое"
      ]
    },
    "🗑️ Мусор/контейнеры": {
      "description": "Проблемы с мусором и контейнерами",
      "fields": ["address", "description", "photos", "contact_name", "contact_phone"],
      "subcategories": [
        "♻️ Переполненные контейнеры",
        "🔥 Стихийная свалка",
        "🛻 Сброс мусора с транспорта",
        "🔨 Поврежденные контейнеры",
        "🤢 Грязная площадка/нужна уборка",
        "🌫️ Нужна помывка контейнеров",
        "🐀 Дератизация/дезинсекция",
        "🚮 Нет контейнера",
        "🗓️ Несвоевременный вывоз/пропуск графика",
        "🔍 Другое"
      ]
    },
    "🚧 Дороги и ямы": {
      "description": "Проблемы дорог, тротуаров и дорожной инфраструктуры",
      "fields": ["address", "description", "photos", "contact_name", "contact_phone"],
      "subcategories": [
        "🕳️ Ямы на дорогах/тротуарах",
        "🧱 Разрушенное покрытие",
        "❄️ Неубранный снег/наледь",
        "🚥 Светофор не работает",
        "🚫 Знак отсутствует/сломался",
        "📏 Нет разметки/стерлась",
        "💧 Глубокие лужи/нужна откачка",
        "🧱 Бордюры/поребрики разрушены",
        "🧑‍🦽 Пандусы/тактильная плитка отсутствуют",
        "🕯️ Уличное освещение не работает",
        "🕹️ Сломаны дорожные ограждения",
        "🐢 Пробки из-за организации движения",
        "🔍 Другое"
      ]
    },
    "🌳 Озеленение/вырубка": {
      "description": "Проблемы с деревьями, кустами и зелеными насаждениями",
      "fields": ["address", "description", "photos"],
      "subcategories": [
        "🪓 Незаконная вырубка",
        "🌿 Заросли/сорняки — нужен покос",
        "🌲 Кусты/деревья закрывают обзор",
        "🥀 Посадки в плохом состоянии",
        "⚠️ Сухостой/риск падения",
        "💧 Нужен полив",
        "🐛 Вредители/болезни",
        "🌷 Требуются новые посадки",
        "♻️ Листва/ветки не вывезены",
        "🔍 Другое"
      ]
    },
    "🔧 ЖКХ": {
      "description": "Жилищно-коммунальное хозяйство",
      "fields": ["address", "description", "photos", "contact_phone"],
      "subcategories": [
        "💦 Прорыв трубы",
        "🕳️ Открытый люк",
        "💡 Не горит уличный фонарь",
        "🔌 Обрыв/искрение проводов",
        "🧯 Пожарная безопасность нарушена",
        "🚽 Протечка канализации",
        "🔍 Другое"
      ]
    },
    "🏞️ Благоустройство": {
      "description": "Состояние дворов, парков, скверов",
      "fields": ["address", "description", "photos"],
      "subcategories": [
        "🪑 Сломаны лавочки/урны",
        "🛝 Детская площадка повреждена/опасна",
        "🚴 Дефекты велодорожек/скейт-зон",
        "🚻 Туалеты не работают/грязные",
        "🧼 Территория грязная/нужен субботник",
        "🧊 Гололед на прогулочных зонах",
        "🔍 Другое"
      ]
    },
    "🅿️ Парковки": {
      "description": "Проблемы с парковками",
      "fields": ["address", "description", "vehicle_number", "photos"],
      "subcategories": [
        "🅿️ Нелегальная парковка/блокировка",
        "🚫 Парковка на газоне/тротуаре",
        "🚓 Нужен эвакуатор",
        "💳 Не работает оплата/паркомат",
        "🪧 Нет знаков/разметки парковки",
        "🚗 Брошенный/бесхозный транспорт",
        "🔍 Другое"
      ]
    },
    "🏗️ Стройка и шум": {
      "description": "Проблемы со строительством и шумом",
      "fields": ["address", "description", "photos", "contact_phone"],
      "subcategories": [
        "🔊 Шум ночью/нарушение тишины",
        "🧱 Опасный стройобъект/ограждения",
        "🧹 Строительный мусор",
        "🚧 Перекрытие прохода без схемы",
        "🚙 Выезд со стройплощадки без мойки колес",
        "🔍 Другое"
      ]
    },
    "🐾 Животные": {
      "description": "Проблемы с животными",
      "fields": ["address", "description", "photos"],
      "subcategories": [
        "🐕 Агрессивные/бездомные собаки",
        "💀 Мертвое животное",
        "🐱 Раненые/потерянные животные",
        "💩 Неубранные экскременты",
        "🐀 Крысы/мыши во дворе/подвале",
        "🔍 Другое"
      ]
    },
    "🏬 Торговля и сервис": {
      "description": "Проблемы торговли и сервиса",
      "fields": ["address", "description", "photos"],
      "subcategories": [
        "🧾 Обвес/обман/отказ выдать чек",
        "🍗 Несоблюдение санитарии",
        "🕰️ Торговля в неположенное время",
        "🚫 Незаконная торговля",
        "🔊 Уличная реклама/звуки мешают",
        "🔍 Другое"
      ]
    },
    "🌊 Водоемы": {
      "description": "Проблемы водоемов и набережных",
      "fields": ["address", "description", "photos"],
      "subcategories": [
        "🏖️ Загрязнение берега/воды",
        "🛶 Опасные/сломанные пирсы/понтоны",
        "🚫 Купание запрещено — нет знаков",
        "🌿 Заросли камыша - требуется покос",
        "☠️ Сброс вредных веществ в водоем",
        "🔍 Другое"
      ]
    },
    "🏚️ Аварийные здания": {
      "description": "Опасные и аварийные здания",
      "fields": ["address", "description", "photos", "contact_phone"],
      "subcategories": [
        "🧱 Трещины/обрушения",
        "🚷 Опасные подъезды/лестницы",
        "🪧 Нет предупреждающих табличек",
        "🔍 Другое"
      ]
    },
    "🧭 Навигация": {
      "description": "Проблемы навигации и доступности",
      "fields": ["address", "description"],
      "subcategories": [
        "🔡 Нет адресных табличек/номеров домов",
        "🟨 Тактильная плитка повреждена/отсутствует",
        "🦽 Нет доступного входа/кнопки вызова",
        "🛗 Неисправен лифтовой подъемник",
        "🔍 Другое"
      ]
    },
    "📢 Обратная связь": {
      "description": "Предложения и сообщения об ошибках",
      "fields": ["description"],
      "subcategories": [
        "💬 Предложение по улучшению",
        "🗣️ Сообщить об ошибке"
      ]
    },
    "✅ Благодарность": {
      "description": "Благодарности за хорошую работу",
      "fields": ["description"],
      "subcategories": [
        "✅ Благодарность"
      ]
    }
  },
  "field_definitions": {
    "route_number": {
      "label": "Номер маршрута",
      "prompt": "Укажите номер маршрута (например: 2, 15К, 42А):",
      "type": "text",
      "required": true
    },
    "vehicle_number": {
      "label": "Номер ТС",
      "prompt": "Укажите номер транспортного средства или госномер (или Пропустить):",
      "type": "text",
      "required": false
    },
    "address": {
      "label": "Адрес",
      "prompt": "Укажите адрес проблемы:",
      "type": "address_or_location",
      "required": true
    },
    "description": {
      "label": "Описание",
      "prompt": "Опишите проблему подробно:",
      "type": "text",
      "required": true
    },
    "photos": {
      "label": "Фото",
      "prompt": "Отправьте до 3-х фото проблемы (можно альбомом или по одному). Нажмите Далее когда закончите:",
      "type": "photos",
      "required": false
    },
    "contact_name": {
      "label": "ФИО",
      "prompt": "Укажите ваши ФИО для связи (или Пропустить):",
      "type": "text",
      "required": false
    },
    "contact_phone": {
      "label": "Телефон",
      "prompt": "Отправьте контактный телефон:",
      "type": "phone",
      "required": false
    }
  }
}
CATEOF

echo "✅ config/categories.json (с ФИО и телефоном)"

# Продолжение в части 2...
