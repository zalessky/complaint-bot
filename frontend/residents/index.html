<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body{font-family:sans-serif;padding:16px;background:#f5f5f5;margin:0}
.card{background:#fff;padding:16px;margin:12px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.category{font-weight:600;margin-bottom:8px}
.photo{max-width:100%;border-radius:8px;margin:4px 0}
.btn{background:#0088cc;color:#fff;border:none;padding:12px;border-radius:8px;width:100%;margin-top:20px;font-size:16px}
.status{padding:4px 8px;border-radius:8px;font-size:12px;display:inline-block;margin:8px 0}
.status-new{background:#ffeaa7;color:#000}
.status-in_progress{background:#74b9ff;color:#000}
.status-resolved{background:#55efc4;color:#000}
</style>
</head><body><h2>üìã –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2><div id="list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<button class="btn" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
<script>
const tg=window.Telegram.WebApp;tg.ready();tg.expand();
const urlParams=new URLSearchParams(window.location.search);
const userId=tg.initDataUnsafe?.user?.id||urlParams.get('user_id');

const statusText={
  new:'üü° –ù–æ–≤–æ–µ',
  in_progress:'üîµ –í —Ä–∞–±–æ—Ç–µ',
  resolved:'üü¢ –†–µ—à–µ–Ω–æ',
  rejected:'üî¥ –û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
};

async function load(){
  try{
    if(!userId){document.getElementById('list').innerHTML='<div class="card">‚ùå –ù–µ—Ç user ID</div>';return;}
    const res=await fetch(`/api/v1/complaints/my?user_id=${userId}`);
    if(!res.ok){document.getElementById('list').innerHTML=`<div class="card">‚ùå –û—à–∏–±–∫–∞ ${res.status}</div>`;return;}
    const data=await res.json();
    if(data.length===0){document.getElementById('list').innerHTML='<div class="card">–ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π</div>';return;}
    
    document.getElementById('list').innerHTML=data.map(c=>{
      let html=`<div class="card"><div class="category">${c.category}</div>`;
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º photos - –º–æ–∂–µ—Ç –±—ã—Ç—å JSON array
      if(c.photos){
        try{
          const photos=JSON.parse(c.photos);
          if(Array.isArray(photos)){
            photos.forEach(fileId=>{
              html+=`<img class="photo" src="/api/v1/photos/${fileId}" alt="–§–æ—Ç–æ">`;
            });
          }else{
            html+=`<img class="photo" src="/api/v1/photos/${c.photos}" alt="–§–æ—Ç–æ">`;
          }
        }catch(e){
          // –ï—Å–ª–∏ –Ω–µ JSON, –∑–Ω–∞—á–∏—Ç –æ–¥–∏–Ω file_id
          html+=`<img class="photo" src="/api/v1/photos/${c.photos}" alt="–§–æ—Ç–æ">`;
        }
      }
      
      html+=`<div style="margin:8px 0;white-space:pre-wrap">${c.description||''}</div>`;
      html+=`<div class="status status-${c.status}">${statusText[c.status]||c.status}</div>`;
      html+=`<div style="color:#888;font-size:12px;margin-top:8px">${new Date(c.created_at).toLocaleString('ru-RU')}</div>`;
      html+=`</div>`;
      return html;
    }).join('');
  }catch(e){
    console.error(e);
    document.getElementById('list').innerHTML=`<div class="card">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}
load();
</script></body></html>
