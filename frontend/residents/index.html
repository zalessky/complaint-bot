<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>body{font-family:sans-serif;padding:16px;background:#f5f5f5}.card{background:#fff;padding:16px;margin:12px 0;border-radius:8px}.btn{background:#0088cc;color:#fff;border:none;padding:12px;border-radius:8px;width:100%;margin-top:20px}</style>
</head><body><h2>üìã –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2><div id="list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<button class="btn" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
<script>
const tg=window.Telegram.WebApp;tg.ready();tg.expand();

// –ß–∏—Ç–∞–µ–º user_id –∏–∑ URL
const urlParams = new URLSearchParams(window.location.search);
const userIdFromUrl = urlParams.get('user_id');

async function load(){
  try{
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å userId –∏–∑ Telegram –∏–ª–∏ –∏–∑ URL
    const userId = tg.initDataUnsafe?.user?.id || userIdFromUrl;
    
    console.log('User ID from Telegram:', tg.initDataUnsafe?.user?.id);
    console.log('User ID from URL:', userIdFromUrl);
    console.log('Final User ID:', userId);
    
    if(!userId){
      document.getElementById('list').innerHTML='<div class="card">‚ùå –ù–µ—Ç user ID</div>';
      return;
    }
    
    const res=await fetch(`/api/v1/complaints/my?user_id=${userId}`);
    console.log('Response:', res.status);
    
    if(!res.ok){
      const text = await res.text();
      document.getElementById('list').innerHTML=`<div class="card">‚ùå –û—à–∏–±–∫–∞ ${res.status}: ${text}</div>`;
      return;
    }
    
    const data=await res.json();
    console.log('Loaded complaints:', data.length);
    
    if(data.length===0){
      document.getElementById('list').innerHTML='<div class="card">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π</div>';
      return;
    }
    
    document.getElementById('list').innerHTML=data.map(c=>`
      <div class="card">
        <strong>${c.category}</strong><br>
        <div style="margin:8px 0;white-space:pre-wrap">${c.description}</div>
        <small style="color:#888">${new Date(c.created_at).toLocaleString('ru-RU')}</small>
      </div>
    `).join('');
  }catch(e){
    console.error('Error:', e);
    document.getElementById('list').innerHTML=`<div class="card">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}
load();
</script></body></html>
